import os
import random
from dotenv import load_dotenv
from openai import OpenAI
from translator_util import translate_text, detect_language  # your translation module

# ------------------- Load environment -------------------
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
client = None
if api_key:
    client = OpenAI(api_key=api_key)


# ------------------- Greetings & Farewells -------------------
greetings = {
    "en": ["hello", "hi", "hey", "good morning", "good afternoon", "good evening"],
    "ta": ["ро╡рогроХрпНроХроорпН", "ро╣ро▓рпЛ"],
    "hi": ["рдирдорд╕реНрддреЗ", "рд╣реИрд▓реЛ"],
    "ml": ["р┤╣р┤▓р╡Л", "р┤ир┤ор┤╕р╡Нр┤Хр╡Нр┤Хр┤╛р┤░р┤В"],
    "te": ["р░╣р░▓р▒Л", "р░ир░ор░╕р▒Нр░др▒З"]
}

greeting_responses = {
    "en": ["Hello! How can I help you today?", "Hi there! Ask me anything about farming. ЁЯМ╛"],
    "ta": ["ро╡рогроХрпНроХроорпН! роЗройрпНро▒рпБ роЙроЩрпНроХро│рпБроХрпНроХрпБ роОро╡рпНро╡ро╛ро▒рпБ роЙродро╡ро▓ро╛роорпН?"],
    "hi": ["рдирдорд╕реНрддреЗ! рдЦреЗрддреА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореБрдЭрд╕реЗ рдХреБрдЫ рднреА рдкреВрдЫреЗрдВред ЁЯМ▒"],
    "ml": ["р┤╣р┤▓р╡Л! р┤Хр╡Гр┤╖р┤┐р┤пр╡Ж р┤Хр╡Бр┤▒р┤┐р┤Ър╡Нр┤Ър╡Н р┤Ор┤ир╡Нр┤др╡Жр┤Щр╡Нр┤Хр┤┐р┤▓р╡Бр┤В р┤Ър╡Лр┤жр┤┐р┤Хр╡Нр┤Хр┤╛р┤В. ЁЯМ┐"],
    "te": ["р░╣р░▓р▒Л! р░╡р▒Нр░пр░╡р░╕р░╛р░пр░В р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░Пр░жр▒Ир░ир░╛ р░Ер░бр░Чр░Вр░бр░┐. ЁЯМ▒"]
}

farewells = {
    "en": ["bye", "goodbye", "see you", "thanks", "thank you"],
    "ta": ["рокро┐ро░ро┐ропро╛ро╡ро┐роЯрпИ", "роиройрпНро▒ро┐"],
    "hi": ["рдЕрд▓рд╡рд┐рджрд╛", "рдзрдиреНрдпрд╡рд╛рдж"],
    "ml": ["р┤╡р┤┐р┤Я", "р┤ир┤ир╡Нр┤жр┤┐"],
    "te": ["р░╡р▒Ар░бр▒Нр░Хр▒Лр░▓р▒Б", "р░зр░ир▒Нр░пр░╡р░╛р░жр░╛р░▓р▒Б"]
}

farewell_responses = {
    "en": ["Goodbye! Happy farming! ЁЯМ╛", "You're welcome! ЁЯШК"],
    "ta": ["ро╡ро╛ро┤рпНродрпНродрпБроХро│рпН! роороХро┐ро┤рпНроЪрпНроЪро┐ропро╛рой ро╡ро┐ро╡роЪро╛ропроорпН! ЁЯМ╛"],
    "hi": ["рдЕрд▓рд╡рд┐рджрд╛! рдЦреЗрддреА рдореЗрдВ рд╕рдлрд▓рддрд╛ рдорд┐рд▓реЗ! ЁЯМ▒"],
    "ml": ["р┤╡р┤┐р┤Я! р┤╕р┤ир╡Нр┤др╡Лр┤╖р┤Хр┤░р┤ор┤╛р┤п р┤Хр╡Гр┤╖р┤┐ р┤Ър╡Жр┤пр╡Нр┤пр╡Бр┤Х! ЁЯМ┐"],
    "te": ["р░╡р▒Ар░бр▒Нр░Хр▒Лр░▓р▒Б! р░╕р░Вр░др▒Лр░╖р░Хр░░р░ор▒Ир░и р░╡р▒Нр░пр░╡р░╕р░╛р░пр░В! ЁЯМ▒"]
}


# ------------------- Offline Knowledge Base -------------------
queries = {
    "soil": {
        # Cereals
        "cotton": {
            "en": "Cotton grows best in deep, fertile, well-drained sandy loam soil with good moisture retention.",
            "ta": "рокро░рпБродрпНродро┐ роЖро┤рооро╛рой, ро╡ро│рооро╛рой, роиройрпНроХрпБ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН роЪро┐ро▒рокрпНрокро╛роХ ро╡ро│ро░рпБроорпН.",
            "hi": "рдХрдкрд╛рд╕ рдЧрд╣рд░реА, рдЙрдкрдЬрд╛рдК, рдЕрдЪреНрдЫреА рдЬрд▓ рдирд┐рдХрд╛рд╕реА рд╡рд╛рд▓реА рдмрд▓реБрдИ рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддреА рд╣реИред",
            "ml": "р┤кр┤Юр╡Нр┤Ър╡Б р┤Жр┤┤р┤ор╡Бр┤│р╡Нр┤│, р┤╡р┤│р┤ор╡Бр┤│р╡Нр┤│, р┤ир┤▓р╡Нр┤▓ р┤бр╡Нр┤░р╡Жр┤пр╡НтАМр┤ир╡Зр┤Ьр╡Н р┤Йр┤│р╡Нр┤│ р┤ор┤гр╡╜-р┤Ър╡Жр┤Щр╡Нр┤Хр┤▓р╡Нр┤▓р╡Н р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░кр░др▒Нр░др░┐ р░▓р▒Лр░др▒Ир░и, р░╕р░╛р░░р░╡р░Вр░др░ор▒Ир░и, р░мр░╛р░Чр░╛ р░бр▒Нр░░р▒Ир░ир▒Зр░Ьр▒А р░Йр░ир▒Нр░и р░Зр░╕р▒Бр░Х р░▓р▒Лр░ор▒Н р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др▒Бр░Вр░жр░┐."
        },
        "rice": {
            "en": "Rice grows best in clayey loam soil with good water retention.",
            "ta": "роЕро░ро┐роЪро┐ роиро▓рпНро▓ роирпАро░рпН родро╛роЩрпНроХрпБроорпН родро┐ро▒ройрпН роХрпКрогрпНроЯ рокроЮрпНроЪрпБрокрпН рокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН роЪро┐ро▒рокрпНрокро╛роХ ро╡ро│ро░рпБроорпН.",
            "hi": "рдЪрд╛рд╡рд▓ рдЪрд┐рдХрдиреА рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдЙрдЧрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдкрд╛рдиреА рдХреА рдЕрдЪреНрдЫреА рдзрд╛рд░рдг рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИред",
            "ml": "р┤Ер┤░р┤┐ р┤ир┤▓р╡Нр┤▓ р┤Ьр┤▓р┤зр┤╛р┤░р┤гр┤ор╡Бр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤ор┤┐р┤Хр┤Ър╡Нр┤Ър┤др┤╛р┤пр┤┐ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░мр░┐р░пр▒Нр░пр░В р░ор░Вр░Ър░┐ р░ир▒Ар░░р▒Б р░ир░┐р░▓р▒Нр░╡ р░Ър▒Зр░╕р▒З р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др▒Бр░Вр░жр░┐."
        },
        "wheat": {
            "en": "Wheat prefers loamy or alluvial soil with good drainage.",
            "ta": "роХрпЛродрпБроорпИ роиро▓рпНро▓ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдЧреЗрд╣реВрдВ рдЕрдЪреНрдЫреЗ рдЬрд▓ рдирд┐рдХрд╛рд╕реА рд╡рд╛рд▓реЗ рджреЛрдордЯ рдпрд╛ рдЬрд▓реЛрдврд╝ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤Чр╡Лр┤др┤ор╡Нр┤кр╡Н р┤ир┤▓р╡Нр┤▓ р┤бр╡Нр┤░р╡Жр┤пр╡НтАМр┤ир╡Зр┤Ьр╡Н р┤Йр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░Чр▒Лр░зр▒Бр░ор░▓р▒Б р░ор░Вр░Ър░┐ р░бр▒Нр░░р▒Ир░ир▒Зр░Ьр▒А р░Йр░ир▒Нр░и р░▓р▒Лр░ор▒Н р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        },
        "maize": {
            "en": "Maize grows well in well-drained sandy loam or loamy soil rich in organic matter.",
            "ta": "роЪрпЛро│роорпН роиройрпНроХрпБ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ, роЙропро┐ро░рпНроЪрпНроЪродрпНродрпБ роиро┐ро▒рпИроирпНрод роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдордХреНрдХрд╛ рдЕрдЪреНрдЫреА рдЬрд▓ рдирд┐рдХрд╛рд╕реА рд╡рд╛рд▓реА рдмрд▓реБрдИ рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤Ър╡Лр┤│р┤В р┤Ьр╡Ир┤╡р┤╡р┤╕р╡Нр┤др╡Бр┤Хр╡Нр┤Хр┤│р┤┐р╡╜ р┤╕р┤ор╡Нр┤кр┤ир╡Нр┤ир┤ор┤╛р┤п р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░ор▒Кр░Хр▒Нр░Хр░Ьр▒Кр░ир▒Нр░и р░╕р▒Зр░Вр░жр▒Нр░░р▒Ар░п р░кр░жр░╛р░░р▒Нр░ер░╛р░▓р░др▒Л р░╕р░ор▒Гр░жр▒Нр░зр░┐р░Чр░╛ р░Йр░ир▒Нр░и р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др▒Бр░Вр░жр░┐."
        },

        # Vegetables
        "tomato": {
            "en": "Tomatoes grow best in well-drained, fertile sandy loam soil with pH 6.0тАУ6.8.",
            "ta": "родроХрпНроХро╛ро│ро┐ роиройрпНроХрпБ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ ро╡ро│рооро╛рой роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН роЪро┐ро▒рокрпНрокро╛роХ ро╡ро│ро░рпБроорпН.",
            "hi": "рдЯрдорд╛рдЯрд░ рдЙрдкрдЬрд╛рдК рдмрд▓реБрдИ рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддреЗ рд╣реИрдВред",
            "ml": "р┤др┤Хр╡Нр┤Хр┤╛р┤│р┤┐ р┤╡р┤│р┤ор╡Бр┤│р╡Нр┤│ р┤ор┤гр╡╜ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤ор┤┐р┤Хр┤Ър╡Нр┤Ър┤др┤╛р┤пр┤┐ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░Яр░ор░╛р░Яр░╛р░▓р▒Б р░ор░Вр░Ър░┐ р░бр▒Нр░░р▒Ир░ир▒Зр░Ьр▒А р░Йр░ир▒Нр░и р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        },
        "potato": {
            "en": "Potatoes prefer loose, well-drained loamy soil with good organic content.",
            "ta": "роЙро░рпБро│рпИроХрпНроХро┐ро┤роЩрпНроХрпБ роЙропро┐ро░рпНроЪрпНроЪродрпНродрпБ роиро┐ро▒рпИроирпНрод роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдЖрд▓реВ рдЙрдкрдЬрд╛рдК рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤Йр┤░р╡Бр┤│р┤Хр╡Нр┤Хр┤┐р┤┤р┤Щр╡Нр┤Щр╡Н р┤ир┤▓р╡Нр┤▓ р┤Ьр╡Ир┤╡р┤╡р┤╕р╡Нр┤др╡Бр┤Хр╡Нр┤Хр┤│р╡Бр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░мр░Вр░Чр░╛р░│р░жр▒Бр░Вр░кр░▓р▒Б р░╕р▒Зр░Вр░жр▒Нр░░р▒Ар░п р░кр░жр░╛р░░р▒Нр░ер░╛р░▓р░др▒Л р░╕р░ор▒Гр░жр▒Нр░зр░┐р░Чр░╛ р░Йр░ир▒Нр░и р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        },
        "onion": {
            "en": "Onions require well-drained sandy loam soil with neutral to slightly alkaline pH.",
            "ta": "ро╡рпЖроЩрпНроХро╛ропроорпН роиройрпНроХрпБ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдкреНрдпрд╛рдЬ рдмрд▓реБрдИ рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤╕р┤╡р┤╛р┤│ р┤ор┤гр╡╜ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤ор┤┐р┤Хр┤Ър╡Нр┤Ър┤др┤╛р┤пр┤┐ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░Йр░▓р▒Нр░▓р░┐р░кр░╛р░пр░▓р▒Б р░▓р▒Лр░ор▒Н р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        },
        "carrot": {
            "en": "Carrots grow well in deep, sandy, loose soil to allow root development.",
            "ta": "роХро╛ро░роЯрпН роЖро┤рооро╛рой роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН роЪро┐ро▒рокрпНрокро╛роХ ро╡ро│ро░рпБроорпН.",
            "hi": "рдЧрд╛рдЬрд░ рд░реЗрддреАрд▓реА рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤Хр┤╛р┤░р┤▒р╡Нр┤▒р╡Н р┤Жр┤┤р┤ор╡Бр┤│р╡Нр┤│ р┤ор┤гр╡╜ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░Чр░╛р░Ьр░░ р░Чр░бр▒Нр░бр░┐ р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др▒Бр░Вр░жр░┐."
        },

        # Fruits
        "mango": {
            "en": "Mangoes prefer deep, well-drained sandy loam soil rich in organic matter.",
            "ta": "рооро╛роорпНрокро┤роорпН роиройрпНроХрпБ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ ро╡ро│рооро╛рой роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдЖрдо рдмрд▓реБрдИ рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤ор┤╛р┤ор╡Нр┤кр┤┤р┤В р┤╡р┤│р┤ор╡Бр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░ор░╛р░ор░┐р░бр░┐ р░▓р▒Лр░ор▒Н р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др▒Бр░Вр░жр░┐."
        },
        "banana": {
            "en": "Bananas grow best in rich, well-drained loamy soil with high moisture retention.",
            "ta": "ро╡ро╛ро┤рпИ роЙропро░рпН роИро░рокрпНрокродроорпН роХрпКрогрпНроЯ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдХреЗрд▓рд╛ рдЙрдкрдЬрд╛рдК рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤╡р┤╛р┤┤р┤кр╡Нр┤кр┤┤р┤В р┤ир┤▓р╡Нр┤▓ р┤Ьр┤▓р┤зр┤╛р┤░р┤гр┤ор╡Бр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░Ер░░р░Яр░┐р░кр░Вр░бр▒Нр░▓р▒Б р░▓р▒Лр░ор▒Н р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        },
        "apple": {
            "en": "Apples require well-drained loamy soil with good fertility and slightly acidic pH.",
            "ta": "роЖрокрпНрокро┐ро│рпН роиро▓рпНро▓ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рд╕реЗрдм рдЕрдореНрд▓реАрдп рдЬрд▓ рдирд┐рдХрд╛рд╕реА рд╡рд╛рд▓реА рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддреЗ рд╣реИрдВред",
            "ml": "р┤Жр┤кр╡Нр┤кр┤┐р╡╛ р┤ир┤▓р╡Нр┤▓ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░Жр░кр░┐р░▓р▒Н р░▓р▒Лр░ор▒Н р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др▒Бр░Вр░жр░┐."
        },
        "orange": {
            "en": "Oranges grow best in deep, sandy loam soil with good drainage.",
            "ta": "роЖро░роЮрпНроЪрпБ роиройрпНроХрпБ ро╡роЯро┐роХро╛ро▓роорпИрокрпНрокрпБ роХрпКрогрпНроЯ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рд╕рдВрддрд░рд╛ рдмрд▓реБрдИ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддрд╛ рд╣реИред",
            "ml": "р┤Ур┤▒р┤Юр╡Нр┤Ър╡Н р┤ир┤▓р╡Нр┤▓ р┤бр╡Нр┤░р╡Жр┤пр╡НтАМр┤ир╡Зр┤Ьр╡Н р┤Йр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░ир░╛р░░р░┐р░Вр░Ьр░▓р▒Б р░Зр░╕р▒Бр░Х р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        },
        "grape": {
            "en": "Grapes prefer well-drained sandy loam soil with moderate fertility.",
            "ta": "родро┐ро░ро╛роЯрпНроЪрпИ роорогро▒рпНрокро╛роЩрпНроХрпБ роорогрпНрогро┐ро▓рпН ро╡ро│ро░рпБроорпН.",
            "hi": "рдЕрдВрдЧреВрд░ рдмрд▓реБрдИ рджреЛрдордЯ рдорд┐рдЯреНрдЯреА рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рдЙрдЧрддреЗ рд╣реИрдВред",
            "ml": "р┤ор╡Бр┤ир╡Нр┤др┤┐р┤░р┤┐ р┤ир┤▓р╡Нр┤▓ р┤бр╡Нр┤░р╡Жр┤пр╡НтАМр┤ир╡Зр┤Ьр╡Н р┤Йр┤│р╡Нр┤│ р┤ор┤гр╡Нр┤гр┤┐р╡╜ р┤╡р┤│р┤░р╡Бр┤ир╡Нр┤ир╡Б.",
            "te": "р░жр▒Нр░░р░╛р░Хр▒Нр░╖р░▓р▒Б р░Зр░╕р▒Бр░Х р░ор░Яр▒Нр░Яр░┐р░▓р▒Л р░мр░╛р░Чр░╛ р░кр▒Жр░░р▒Бр░Чр▒Бр░др░╛р░пр░┐."
        }
    },

    "fertilizer": {
        "en": [
            "Use organic compost and nitrogen-rich fertilizer for better yield.",
            "Phosphorus and potassium fertilizers help root growth.",
            "Apply balanced NPK fertilizer according to soil test results."
        ],
        "ta": ["роорпЗро▓рпНродро░роорпН ро╡ро┐ро│рпИроЪрпНроЪро▓рпН рокрпЖро▒ роЙропро┐ро░рпНроЪрпНроЪродрпНродрпБ роиро┐ро▒рпИроирпНрод роЙро░роорпН рокропройрпНрокроЯрпБродрпНродро╡рпБроорпН.", "ро╡рпЗро░рпН ро╡ро│ро░рпНроЪрпНроЪро┐роХрпНроХрпБ рокро╛ро╕рпНрокро░ро╕рпН рооро▒рпНро▒рпБроорпН рокрпКроЯрпНроЯро╛роЪро┐ропроорпН роЙро░роЩрпНроХро│рпН роЙродро╡рпБроорпН."],
        "hi": ["рдмреЗрд╣рддрд░ рдЙрдкрдЬ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдмрдирд┐рдХ рдЦрд╛рдж рдФрд░ рдирд╛рдЗрдЯреНрд░реЛрдЬрди-рд╕рдореГрджреНрдз рдЙрд░реНрд╡рд░рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред", "рдЬрдбрд╝ рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП рдлреЙрд╕реНрдлреЛрд░рд╕ рдФрд░ рдкреЛрдЯреЗрд╢рд┐рдпрдо рдЙрд░реНрд╡рд░рдХ рдорджрдж рдХрд░рддреЗ рд╣реИрдВред"],
        "ml": ["р┤ор┤┐р┤Хр┤Ър╡Нр┤Ъ р┤╡р┤┐р┤│р┤╡р┤┐р┤ир╡Н р┤Ьр╡Ир┤╡ р┤╡р┤│р┤╡р╡Бр┤В р┤ир╡Ир┤Яр╡Нр┤░р┤Ьр╡╗ р┤╕р┤ор╡Нр┤кр┤ир╡Нр┤и р┤╡р┤│р┤╡р╡Бр┤В р┤Йр┤кр┤пр╡Лр┤Чр┤┐р┤Хр╡Нр┤Хр╡Бр┤Х."],
        "te": ["р░ор░Вр░Ър░┐ р░жр░┐р░Чр▒Бр░мр░бр░┐р░Хр░┐ р░Жр░░р▒Нр░Чр░╛р░ир░┐р░Хр▒Н р░Хр░╛р░Вр░кр▒Лр░╕р▒Нр░Яр▒Н р░ор░░р░┐р░пр▒Б р░ир░┐р░Яр▒Нр░░р▒Лр░Ьр░ир▒Н-р░░р░┐р░Ър▒Н р░Ор░░р▒Бр░╡р▒Бр░▓р░ир▒Б р░Йр░кр░пр▒Лр░Чр░┐р░Вр░Ър░Вр░бр░┐."]
    },

    "pest": {
        "en": [
            "Neem oil is effective against many pests.",
            "Use natural pesticides like garlic or chili extracts for eco-friendly farming.",
            "Regular monitoring and crop rotation help reduce pest attacks."
        ],
        "ta": ["роирпАроорпН роОрогрпНрогрпЖропрпН рокро▓ рокрпВроЪрпНроЪро┐роХро│рпБроХрпНроХрпБ ро╡ро┐ро│рпИро╡рпБро│рпНро│родрпБ."],
        "hi": ["рдиреАрдо рдХрд╛ рддреЗрд▓ рдХрдИ рдХреАрдбрд╝реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рднрд╛рд╡реА рд╣реИред"],
        "ml": ["р┤ир╡Ар┤В р┤Ор┤гр╡Нр┤г р┤кр┤▓ р┤Хр╡Ар┤Яр┤Щр╡Нр┤Щр╡╛р┤Хр╡Нр┤Хр╡Н р┤лр┤▓р┤кр╡Нр┤░р┤жр┤ор┤╛р┤гр╡Н."],
        "te": ["р░ир▒Ар░ор▒Лр░пр░┐р░▓р▒Н р░Ър░╛р░▓р░╛ pests р░Хр▒Б р░╕р░ор░░р▒Нр░ер░╡р░Вр░др░Вр░Чр░╛ р░кр░ир░┐р░Ър▒Зр░╕р▒Нр░др▒Бр░Вр░жр░┐."]
    },

    "harvest": {
        "en": "Harvesting depends on the crop type. Ensure proper maturity before harvesting for best yield.",
        "ta": "рокро┤роЩрпНроХро│рпН роЕро▒рпБро╡роЯрпИ роЪрпЖропрпНропрпБроорпН роорпБройрпН роЪро░ро┐ропро╛рой ро╡ро│ро░рпНроЪрпНроЪро┐ рокрпЖро▒рпНро▒ро┐ро░рпБрокрпНрокродрпИ роЙро▒рпБродро┐ роЪрпЖропрпНропрпБроЩрпНроХро│рпН.",
        "hi": "рдлрд╕рд▓ рдХреА рдХрдЯрд╛рдИ рдкреНрд░рдХрд╛рд░ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИред рд╕рд░реНрд╡реЛрддреНрддрдо рдЙрдкрдЬ рдХреЗ рд▓рд┐рдП рд╕рд╣реА рдкрд░рд┐рдкрдХреНрд╡рддрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВред",
        "ml": "р┤╡р┤│р┤╡р╡Б р┤╡р┤┐р┤│р┤╡р╡Жр┤Яр╡Бр┤кр╡Нр┤кр╡Н р┤╡р┤┐р┤│р┤пр╡Бр┤Яр╡Ж р┤др┤░р┤др╡Нр┤др┤┐р╡╜ р┤Жр┤╢р╡Нр┤░р┤┐р┤др┤ор┤╛р┤гр╡Н. р┤ир┤▓р╡Нр┤▓ р┤╡р┤┐р┤│р┤╡р┤┐р┤ир╡Н р┤кр╡Вр╡╝р┤гр┤ор┤╛р┤п р┤╡р┤│р╡╝р┤Ър╡Нр┤Ъ р┤Йр┤▒р┤кр╡Нр┤кр┤╛р┤Хр╡Нр┤Хр╡Бр┤Х.",
        "te": "р░лр░▓р░┐р░др░╛р░ир░┐р░Хр░┐ р░╕р░░р▒Ир░и р░кр░╛р░Хр░╡р░пр░╕р▒Б р░╡р░Ър▒Нр░Ър░┐ р░Йр░ир▒Нр░ир░Яр▒Нр░▓р▒Б р░ир░┐р░░р▒Нр░зр░╛р░░р░┐р░Вр░Ър░Вр░бр░┐."
    }
}


# ------------------- Functions -------------------

def get_offline_response(user_input: str, lang="en"):
    user_input_lower = user_input.lower()
    # Greetings & Farewells handled in process_message
    # Soil
    for crop, translations in queries.get("soil", {}).items():
        if crop in user_input_lower:
            return translations.get(lang, translations.get("en"))
    # Other topics
    for topic in ["fertilizer", "pest", "harvest"]:
        if topic in user_input_lower:
            resp = queries.get(topic, {}).get(lang, queries.get(topic, {}).get("en"))
            return random.choice(resp) if isinstance(resp, list) else resp
    return None


def ask_openai(user_input: str):
    if not client:
        return None
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "You are an agriculture assistant. Reply clearly and concisely."},
                {"role": "user", "content": user_input}
            ],
            temperature=0.5
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print(f"OpenAI error: {e}")
        return None


def process_message(user_input, dest_lang=None):
    """
    1. Detect user language
    2. Check for greetings/farewells
    3. Offline knowledge base first
    4. OpenAI fallback
    5. Offline default fallback
    """
    try:
        user_lang = detect_language(user_input)
    except:
        user_lang = "en"

    if not dest_lang:
        dest_lang = user_lang

    # --- Step 0: Greetings ---
    user_input_lower = user_input.lower()
    for lang, greet_list in greetings.items():
        if any(greet.lower() in user_input_lower for greet in greet_list):
            return random.choice(greeting_responses.get(lang, greeting_responses["en"]))

    # --- Step 0b: Farewells ---
    for lang, bye_list in farewells.items():
        if any(word.lower() in user_input_lower for word in bye_list):
            return random.choice(farewell_responses.get(lang, farewell_responses["en"]))

    # --- Step 1: Offline KB ---
    response = get_offline_response(user_input, lang=dest_lang)
    if response:
        return response

    # --- Step 2: OpenAI fallback ---
    response = ask_openai(user_input)
    if response:
        if dest_lang != "en":
            try:
                response = translate_text(response, dest=dest_lang)
            except:
                pass
        return response

    # --- Step 3: Offline default fallback ---
    defaults = {
        "en": "I couldnтАЩt find an answer. Please ask about soil, fertilizer, pests, or harvesting.",
        "ta": "роиро╛ройрпН рокродро┐ро▓рпИ роХрогрпНроЯро▒ро┐роп роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. родропро╡рпБроЪрпЖропрпНродрпБ роорогро▓рпН, роЙро░роорпН, рокрпВроЪрпНроЪро┐роХро│рпН роЕро▓рпНро▓родрпБ роЕро▒рпБро╡роЯрпИ рокро▒рпНро▒ро┐ роХрпЗро│рпБроЩрпНроХро│рпН.",
        "hi": "рдореИрдВ рдЙрддреНрддрд░ рдирд╣реАрдВ рдкрд╛ рд╕рдХрд╛ред рдХреГрдкрдпрд╛ рдорд┐рдЯреНрдЯреА, рдЙрд░реНрд╡рд░рдХ, рдХреАрдЯ рдпрд╛ рдХрдЯрд╛рдИ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрдЫреЗрдВред",
        "ml": "р┤Юр┤╛р╡╗ р┤Тр┤░р╡Б р┤Йр┤др╡Нр┤др┤░р┤В р┤Хр┤гр╡Нр┤Яр╡Жр┤др╡Нр┤др┤╛р┤ир┤╛р┤пр┤┐р┤▓р╡Нр┤▓. р┤жр┤пр┤╡р┤╛р┤пр┤┐ р┤ор┤гр╡Нр┤гр╡Н, р┤╡р┤│р┤В, р┤Хр╡Ар┤Яр┤Щр╡Нр┤Щр╡╛ р┤Ер┤▓р╡Нр┤▓р╡Жр┤Щр╡Нр┤Хр┤┐р╡╜ р┤╡р┤┐р┤│р┤╡р╡Жр┤Яр╡Бр┤кр╡Нр┤кр╡Н р┤Ър╡Лр┤жр┤┐р┤Хр╡Нр┤Хр╡Бр┤Х.",
        "te": "р░ир▒Зр░ир▒Б р░╕р░ор░╛р░зр░╛р░ир░В р░Хр░ир▒Бр░Чр▒Кр░ир░▓р▒Зр░Хр░кр▒Лр░пр░╛р░ир▒Б. р░жр░пр░Ър▒Зр░╕р░┐ р░ор░Яр▒Нр░Яр▒А, р░Ор░░р▒Бр░╡р▒Б, р░Хр▒Ар░Яр░Хр░╛р░▓ р░▓р▒Зр░жр░╛ р░лр░▓р░┐р░др░╛р░▓ р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░Ер░бр░Чр░Вр░бр░┐."
    }
    return defaults.get(dest_lang, defaults["en"])
